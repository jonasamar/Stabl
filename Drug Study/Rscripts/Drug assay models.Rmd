---
title: "Drug assay mixed models"
output: html_notebook
---

Here we want to quantify the effect of the drugs on each feature. To do that, we decided to build mixed linear models on the whole data (4 patients) for each drug and each feature. We also try simple linear models on the median of the 4 patients data. We then analyzed the results of these models by calculating scores of performances and visualize the best models according to these score to see if this choice of modeling is relevant. 

## Paths

```{r}
setwd("/Users/jonasamar/Stabl/Drug Study/Rscripts")
out_path="/Users/jonasamar/Stabl/Drug Study/Drug assay csv"
```

## Libraries

```{r}
library(tidyverse)
library(tidyselect)
library(reshape2)
library(lme4)
library(lmerTest)
library(ggplot2)
library(r2glmm)
library(sjstats)
library(doSNOW)
library(parallel)
library(dplyr)
library(reticulate)
```

## Linear mixed models

Importing penalized preprocessed data with the different scales.

```{r}
# AllPenDoseresponse
load(paste0(out_path, "/all pen dose response with scales.rda"))
```

Function building a the mixed models for a given drug across the 720 features.

```{r}
build.individual.model <- function(drug.name, dataset){
  # Create an empty data frame to store the results
  models <- data.frame(stringsAsFactors = FALSE)
  
  for (feature.name in unique(dataset$feature)){
    # Subset of the dataset 
    Subset <- dataset %>% 
                  filter(feature == !!feature.name) %>%
                  filter(drug == !!drug.name)  %>%
                  select(c("ID", "dose", "value"))
    for (id in unique(Subset$ID)){
      # Subset at the individual level
      subset <- Subset %>%
                  filter(ID==id) %>%
                  select(c("ID", "dose", "value"))
      # building a linear model only when the response is not constant (we get an error message otherwise...)
      if (length(unique(subset$value)) > 1){
        # Linear model and its scores
        model <- suppressMessages(lm(value ~ dose, data = subset))
        coefs <- coef(model) %>% 
                setNames(c("Intercept", "Slope"))
      
        aic <- AIC(model)
        pval <- summary(model)$coefficients[, "Pr(>|t|)"][["dose"]]
        residuals <- residuals(model)
        rmse <- sqrt(mean(residuals^2))
      }
      else{
        # When there is only one value, the model is constant
        model <- list(unique(subset$value))
        aic <- NA
        pval <- NA
        rmse <- NA
        coefs <- data.frame(ID = 1, Intercept = NA, Slope = NA)
      }
      # Adding new linear model to models
      models <- rbind(models,
                      data.frame(feature = feature.name,
                                 drug = drug.name,
                                 ID=id,
                                 model = I(list(model)),
                                 slope = coefs[["Slope"]],
                                 rmse = rmse,
                                 aic = aic,
                                 pval = pval,
                                 stringsAsFactors = FALSE))
    }
  }
  return(models)
}
```

**log10.linear.mixed.model :** dataframe containing all the informations about the mixed linear models that are built on each feature on a log10 scale of the concentrations.

```{r}
# Setting the dose values to their log10 transform
Doseresponse <- AllPenDoseresponse %>%
                  mutate(dose = log10_dose) %>%
                  filter(is.finite(dose))

# Set up parallel backend using doParallel
cl <- makeSOCKcluster(detectCores())
registerDoSNOW(cl)

# Create individual linear models on log10 scale
log10.individual.linear.model = foreach(drug.name = unique(Doseresponse$drug), 
                                   .packages = c("tidyverse","lme4", "lmerTest","dplyr"),
                                   .combine = rbind) %dopar% build.individual.model(drug.name, Doseresponse)

# Close parallel backend
stopCluster(cl)

# Saving mixed models
save(log10.individual.linear.model, 
     file=paste0(out_path, "/log10 individual linear models.rda"))
```

**log10_1.linear.mixed.model :** dataframe containing all the informations about the mixed linear models that are built on each feature on a log10(x+1) scale of the concentrations.

```{r}
# Setting the dose values to their log10(x+1) transform
Doseresponse <- AllPenDoseresponse %>%
                  mutate(dose = log10_1_dose) %>%
                  filter(is.finite(dose))

# Set up parallel backend using doParallel
cl <- makeSOCKcluster(detectCores())
registerDoSNOW(cl)

# Create individual linear models on log10 scale
log10_1.individual.linear.model = foreach(drug.name = unique(Doseresponse$drug), 
                                   .packages = c("tidyverse","lme4", "lmerTest", "dplyr"),
                                   .combine = rbind) %dopar% build.individual.model(drug.name, Doseresponse)

# Close parallel backend
stopCluster(cl)

# Saving mixed models
save(log10_1.individual.linear.model, 
     file=paste0(out_path, "/log10_1 individual linear models.rda"))
```

**pseudo_log10.linear.mixed.model :** dataframe containing all the informations about the mixed linear models that are built on each feature on a pseudo_log10 (=asinh(x/2)/log(10)) scale of the concentrations.

```{r}
# Setting the dose values to their pseudo log transform
Doseresponse <- AllPenDoseresponse %>%
                  mutate(dose = pseudo_log_dose) %>%
                  filter(is.finite(dose))

# Set up parallel backend using doParallel
cl <- makeSOCKcluster(detectCores())
registerDoSNOW(cl)

# Create linear mixed models on pseudo log scale
pseudo_log10.individual.linear.model = foreach(drug.name = unique(Doseresponse$drug), 
                                   .packages = c("tidyverse","lme4", "lmerTest", "dplyr"),
                                   .combine = rbind) %dopar% build.individual.model(drug.name, Doseresponse)

# Close parallel backend
stopCluster(cl)

# Saving mixed models
save(pseudo_log10.individual.linear.model, 
     file=paste0(out_path, "/pseudo_log10 individual linear models.rda"))
```

## Linear models on medians

Importing penalized preprocessed data with the different scales.

```{r}
# MedianDoseresponse
load(paste0(out_path, "/median pen dose response with scales.rda"))
```

Function building a the linear models for a given drug across the 720 features.

```{r}
build.median.linear.models <- function(drug.name, dataset){
  # Create an empty data frame to store the results
  models <- data.frame(stringsAsFactors = FALSE)
  
  # We look at each drug for a given feature
  for (feature.name in unique(dataset$feature)){
    # subset of the dataset 
    subset <- dataset %>% 
                  filter(feature == !!feature.name) %>%
                  filter(drug == !!drug.name)  %>%
                  select(c("dose", "median_value")) %>%
                  distinct() %>%
                  suppressMessages()

    # building a mixed model only when the response is not constant (we get an error message otherwise...)
    if (length(unique(subset$median_value)) > 1){
      # Linear model and its scores
      model <- suppressMessages(lm(median_value ~ dose, data = subset))
      coefs <- coef(model) %>% 
                setNames(c("Intercept", "Slope"))
      
      aic <- AIC(model)
      pval <- summary(model)$coefficients[, "Pr(>|t|)"][["dose"]]
      residuals <- residuals(model)
      rmse <- sqrt(mean(residuals^2))
    }
    else{
      # When there is only one value, the model is constant
      model <- list(unique(subset$median_value))
      aic <- NA
      pval <- NA
      rmse <- NA
      coefs <- data.frame(ID = 1, Intercept = NA, Slope = NA)
    }
    # Adding new mixed model to mixed.model
    models <- rbind(models,
                    data.frame(feature = feature.name,
                               drug = drug.name,
                               model = I(list(model)),
                               slope = coefs[["Slope"]],
                               rmse = rmse,
                               aic = aic,
                               pval = pval,
                               stringsAsFactors = FALSE))
    
  }
  return(models)
}
```

**log10.median.linear.model :** dataframe containing all the information about the linear models that are built on each feature on a log10 scale of the concentrations.

```{r}
# Setting the dose values to their log10 transform
Doseresponse <- MedianDoseresponse %>%
                  mutate(dose = log10_dose) %>%
                  filter(is.finite(dose))

# Set up parallel backend using doParallel
cl <- makeSOCKcluster(detectCores())
registerDoSNOW(cl)

# Create linear mixed models on log10 scale
log10.median.linear.model = foreach(drug.name = unique(Doseresponse$drug), 
                                   .packages = c("tidyverse","lme4", "lmerTest", "dplyr"),
                                   .combine = rbind) %dopar% build.median.linear.models(drug.name, Doseresponse)

# Close parallel backend
stopCluster(cl)

# Saving mixed models
save(log10.median.linear.model, 
     file=paste0(out_path, "/log10 median linear models.rda"))
```

**log10_1.median.linear.model :** dataframe containing all the information about the linear models that are built on each feature on a log10(x+1) scale of the concentrations.

```{r}
# Setting the dose values to their log10 transform
Doseresponse <- MedianDoseresponse %>%
                  mutate(dose = log10_1_dose) %>%
                  filter(is.finite(dose))

# Set up parallel backend using doParallel
cl <- makeSOCKcluster(detectCores())
registerDoSNOW(cl)

# Create linear mixed models on log10 scale
log10_1.median.linear.model = foreach(drug.name = unique(Doseresponse$drug),
                                      .packages = c("tidyverse","lme4", "lmerTest", "dplyr"),
                                      .combine = rbind) %dopar% build.median.linear.models(drug.name, Doseresponse)

# Close parallel backend
stopCluster(cl)

# Saving mixed models
save(log10_1.median.linear.model, 
     file=paste0(out_path, "/log10_1 median linear models.rda"))
```

**pseudo_log10.median.linear.model :** dataframe containing all the information about the linear models that are built on each feature on a pseudo_log10 scale of the concentrations.

```{r}
# Setting the dose values to their log10 transform
Doseresponse <- MedianDoseresponse %>%
                  mutate(dose = pseudo_log_dose) %>%
                  filter(is.finite(dose))

# Set up parallel backend using doParallel
cl <- makeSOCKcluster(detectCores())
registerDoSNOW(cl)

# Create linear mixed models on log10 scale
pseudo_log10.median.linear.model = foreach(drug.name = unique(Doseresponse$drug),
                                           .packages = c("tidyverse","lme4", "lmerTest", "dplyr"),
                                           .combine = rbind) %dopar% build.median.linear.models(drug.name, Doseresponse)

# Close parallel backend
stopCluster(cl)

# Saving mixed models
save(pseudo_log10.median.linear.model, 
     file=paste0(out_path, "/pseudo_log10 median linear models.rda"))
```

## Determining the most relevant scale and model fitting strategy

Loading the models (Necessary only if you haven't run all the code above).

```{r}
for (scale in c("pseudo_log10", "log10", "log10_1")){
  load(paste(out_path, "/", scale, " median linear models.rda", sep=""))
  load(paste(out_path, "/", scale, " individual linear models.rda", sep=""))
}
```

Looking at how many models are above the pvalue threshold of 0.05

```{r}
print("-------------------------------------------------------")
print("Number of features that are represented by models with pval >= 0.5")
print("-------------------------------------------------------")
indiv.total <- dim(log10.individual.linear.model)[1]
print(paste0("Total number of drugxfeatures combinations (indivual models): ", 
             indiv.total))
print(paste("pseudo_log10.individual.linear.model : ",
             dim(pseudo_log10.individual.linear.model[pseudo_log10.individual.linear.model$pval >=0.5,])[1], " (",
             dim(pseudo_log10.individual.linear.model[pseudo_log10.individual.linear.model$pval >=0.5,])[1]/indiv.total,"%)", 
             sep=""))
print(paste("log10.linear.individual.model : ",
             dim(log10.individual.linear.model[log10.individual.linear.model$pval >=0.5,])[1]," (",
             dim(log10.individual.linear.model[log10.individual.linear.model$pval >=0.5,])[1]/indiv.total,"%)", 
             sep=""))
print(paste("log10_1.individual.linear.model : ",
             dim(log10_1.individual.linear.model[log10_1.individual.linear.model$pval >=0.5,])[1]," (",
             dim(log10_1.individual.linear.model[log10_1.individual.linear.model$pval >=0.5,])[1]/indiv.total,"%)", 
             sep=""))
print("-------------------------------------------------------")
median.total <- dim(log10.median.linear.model)[1]
print(paste("Total number of drugxfeatures combinations (median models): ", 
             median.total))
print(paste("pseudo_log10.median.linear.model : ",
             dim(pseudo_log10.median.linear.model[pseudo_log10.median.linear.model$pval >=0.5,])[1]," (",
             dim(pseudo_log10.median.linear.model[pseudo_log10.median.linear.model$pval >=0.5,])[1]/median.total,"%)", 
             sep=""))
print(paste("log10.median.linear.model : ",
             dim(log10.median.linear.model[log10.median.linear.model$pval >=0.5,])[1]," (",
             dim(log10.median.linear.model[log10.median.linear.model$pval >=0.5,])[1]/median.total,"%)", 
             sep=""))
print(paste0("log10_1.median.linear.model : ",
             dim(log10_1.median.linear.model[log10_1.median.linear.model$pval >=0.5,])[1]," (",
             dim(log10_1.median.linear.model[log10_1.median.linear.model$pval >=0.5,])[1]/median.total,"%)", 
             sep=""))
```

## Linear models analysis

Loading pseudo_log10.median.linear.model and pseudo_log10.linear.mixed.model (Necessary only if you haven't run all the code above).

```{r}
load(paste0(out_path, "/pseudo_log10 median linear models.rda"))
load(paste0(out_path, "/pseudo_log10 individual linear models.rda"))
```

To see which models are the best fit, we decided to rank them based on different scores which are all going to be store in the variable **model.scores**.

```{r}
# Dataframe containing : rmse, slope, absolute value of the slope and the score -log10(pval)*|slope|
median.model.scores <- pseudo_log10.median.linear.model %>%
                          select(-model) %>%
                          mutate(abs.slope = abs(slope),
                                 score = -log(pval, base=10)*abs.slope) %>%
                          distinct(feature, drug, rmse, abs.slope, score, .keep_all = TRUE) %>%
                          arrange(desc(score))

# Dataframe containing : rmse, slope, absolute value of the slope and the score -log10(pval)*|slope|
individual.model.scores <- pseudo_log10.individual.linear.model %>%
                          select(-model) %>%
                          mutate(abs.slope = abs(slope),
                                 score = -log(pval, base=10)*abs.slope) %>%
                          distinct(ID, feature, drug, rmse, abs.slope, score, .keep_all = TRUE) %>%
                          arrange(desc(score))
```

Saving model.scores

```{r}
save(median.model.scores, file=paste0(out_path, "/median model scores.rda"))
save(individual.model.scores, file=paste0(out_path, "/individual model scores.rda"))
```

## Visualization

Importing preprocessed data.

```{r}
# AllPenDoseresponse
load(paste0(out_path, "/all pen dose response with scales.rda"))
# MedianDoseresponse
load(paste0(out_path, "/median pen dose response with scales.rda"))
```

Plotting the best models according to mixed.model.scores

```{r}
load(paste0(out_path, "/individual model scores.rda"))
individual.model.scores
```

Individual models plot

```{r}
# Selecting a specific model
target_feature <- "intMCs_CREB_IFNa"
target_drug <- "Pravastatin"
target_models <- subset(pseudo_log10.individual.linear.model,
                    feature == target_feature & drug == target_drug,
                    select = c("ID", "model"))

# Setting the dose values to their pseudo log transform
Doseresponse <- AllPenDoseresponse %>%
                  mutate(dose = pseudo_log_dose,
                         ID = as.factor(ID)) %>%
                  filter(is.finite(dose))

# Coefficients of the selected model
model_coefs <- target_models %>%
                  mutate(Slope = sapply(model, function(x) coef(x)["dose"]),
                  Intercept = sapply(model, function(x) coef(x)["(Intercept)"]),
                  ID = as.factor(ID))

# Subset of the data for the chosen feature and drug
data <- Doseresponse %>% 
            filter(feature == !!target_feature) %>%
            filter(drug == !!target_drug) %>%
            select(ID, dose, value)

data_rani <- left_join(data, model_coefs, by = "ID")

# Plot
ggplot(data = data_rani,
       mapping = aes(x = dose, 
                     y = value, 
                     colour = ID)) +
  geom_point(na.rm = T, alpha = 0.5) +
  geom_abline(aes(intercept = Intercept, 
                  slope = Slope,
                  colour = ID),
              size = 1.5) +
  theme(legend.position = "top") +
  xlab(target_feature) +
  ylab(target_drug)
```

Plotting the best models according to model.scores

```{r}
load(paste0(out_path, "/median model scores.rda"))
median.model.scores
```

Linear models on median plot

```{r}
# Selecting a specific model
target_feature <- "CD8Tnaive_IkB_IFNa"
target_drug <- "Pravastatin"
target_model <- pseudo_log10.median.linear.model$model[pseudo_log10.median.linear.model$feature == target_feature &
                                                        pseudo_log10.median.linear.model$drug == target_drug][[1]]

# Setting the dose values to their pseudo log transform
Doseresponse <- AllPenDoseresponse %>%
                  mutate(dose = pseudo_log_dose,
                         ID = as.factor(ID)) %>%
                  filter(is.finite(dose))

# Coefficients of the selected model
model_coefs <- coef(target_model) %>%
                  as.data.frame() %>%
                  t() %>%
                  `colnames<-`(c("Intercept", "Slope"))

# Subset of the data for the chosen feature and drug
data <- Doseresponse %>% 
            filter(feature == !!target_feature) %>%
            filter(drug == !!target_drug) %>%
            select(ID, dose, value)

data_rani <- merge(data, model_coefs)

ggplot(data_rani, aes(x=dose, y=value, group=dose)) +
  geom_boxplot() +
  geom_abline(aes(intercept = Intercept, 
                  slope = Slope),
              size = 1.) +
  theme(legend.position = "top") +
  xlab(target_feature) +
  ylab(target_drug)
```
**Conclusion :** The best models seem to fit the data very well. We will always be able to come back to this R script for improvements. We can continue our analysis being confident that the slopes of these mixed and linear models are good estimators of the effect of the drugs on the features.
