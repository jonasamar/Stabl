```{r}
#setwd("/Users/jeinhaus/Library/Mobile Documents/com~apple~CloudDocs/Documents/Stanford # #PostDoc/05 Drug Assay Preterm Birth/R analysis")
#funct_path = "/Users/jeinhaus/Library/Mobile Documents/com~apple~CloudDocs/Documents/Stanford PostDoc/05 #Drug Assay Preterm Birth/R analysis/Drug assay 15 drugs (Regated) - Statistics(1).csv"
#out_path = "/Users/jeinhaus/Library/Mobile Documents/com~apple~CloudDocs/Documents/Stanford PostDoc/05 Drug #Assay Preterm Birth/R analysis"

setwd("/Users/jonasamar/Stabl/Drug Study/Rscripts")
funct_path="/Users/jonasamar/Stabl/Drug Study/Drug assay csv/Drug assay 15 drugs matching gates.csv"
out_path="/Users/jonasamar/Stabl/Drug Study/Drug assay csv"
```

## Libraries

```{r}
library(tidyverse)
library(tidyselect)
library(reshape2)
library(dplyr)
library(pheatmap)
library(RColorBrewer)
library(viridis)
library(paletteer)
library(tidyr)
library(janitor)
```

## Restructuring the Data

```{r}
MyData = read.csv(funct_path)
head(MyData)
```

Removing redundant information (channel/reagent, uniquePopulationName/population) and useless columns (filename, parentPopulation)

```{r}
MyData = subset(MyData, select = -c(filename, uniquePopulationName, parentPopulation, channel))
```

Rewriting the Drug used on each Plate

```{r}
#This vector contains the name of the drugs in the order corresponding to the plate number they were tested
Drugs <- c( 
  "Cefotaxime",
  "Lansoprazole",
  "Iopamidol",
  "Iohexol",
  "Benzylpenicillin",
  "Chlorthalidone",
  "Rifabutin",
  "Iodixanol",
  "Metformin",
  "Folic acid",
  "Clotrimazole",
  "Maprotiline",
  "Progesterone",
  "Pravastatin",
  "Methylpredonisolone"
)

# We associate the name of tje drug corresponding to its plate number in MyData
for (i in seq(1, 15)){
    MyData = MyData %>%
    mutate(Drug =  ifelse(Plate == i, Drugs[i], Drug))
}

# Removing the Plate column
MyData = subset(MyData, select = -c(Plate)) 
```

Getting rid of the units for the doses and associating 0.5% to the null dose (it corresponds DMSO)

```{r}
MyData = MyData %>%
  mutate(Dose =  ifelse(Dose %in% c("1ug", "1ng"), "1" , Dose))
MyData = MyData %>%
  mutate(Dose =  ifelse(Dose %in% c("10ug","10ng"), "10" , Dose))
MyData = MyData %>%
  mutate(Dose =  ifelse(Dose %in% c("100ug", "100ng"), "100" , Dose))
MyData = MyData %>%
  mutate(Dose =  ifelse(Dose %in% c("1000ug", "1000ng"), "1000" , Dose))
MyData = MyData %>%
  mutate(Dose =  ifelse(Dose %in% c("0.50%", "0.5%"), "0", Dose))
```

Renaming the columns for convenience

```{r}
MyData = MyData %>% rename(
  "dose" = "Dose",
  "drug" = "Drug",
  "stimulation" = "Stim"
  )
```

```{r}
head(MyData)
```

## Preprocessing of the features

Here use the asinh transform on the cytometry data and build a feature that is actually the difference between stimulated and un-stimulated samples .

```{r}
final_data = c()
metadata = setdiff(colnames(MyData), c("stimulation", "median"))
```

```{r}
for(dosepoint in unique(MyData$dose)){
  # filtering the data with a specific dose of drug
  MyData_dosepoint = MyData %>% filter(dose == dosepoint)
  # Getting the stims for this dose
  stims = unique(MyData_dosepoint$stimulation) 
  # asinh transformation
  MyData_dosepoint = MyData_dosepoint %>% mutate(feature = asinh(median/5))

  # Removing the median column and calculating Stimulated - Unstimulated
  MyData_dosepoint = MyData_dosepoint[, names(MyData_dosepoint) != "median"] %>%
    pivot_wider(names_from = stimulation, values_from = feature)

  for (stim in stims){
    if (stim!="Unstim"){
      MyData_dosepoint[stim] = MyData_dosepoint[stim] - MyData_dosepoint["Unstim"]
    }
  }
    
  MyData_fin = MyData_dosepoint %>% pivot_longer(-all_of(metadata),
               names_to="stimulation",values_to="feature")

  # Adding the new calculated features to the final dataset
  final_data = rbind(final_data, MyData_fin)
}
```

```{r}
write.csv(final_data, paste(out_path, "preprocessed.csv", sep = "/"))
```

## Data Analysis

Here we want to quantify the behavior of the drugs into three categories : 'Inhibitor', 'Activation', 'FALSE'. Those categories are chosen based on the decrease or increase of the expression of each reagent when the drug dose increases.

### Dataframes

**+++ Maybe we were a bit to hard with the way we characetrized inhibitor and activators...**

```{r}
Doseresponse = final_data %>%
  dplyr::mutate(dose = paste0("D", dose)) %>% # adds a D in front of the dose value
  dcast(population + reagent +drug + stimulation ~ dose, value.var = "feature") %>% 
  mutate(dose_response = case_when(is.na(D1000) == T & D1 > D10 & D10 > D100   ~ 'Inhibitor',
                                  is.na(D1000) == T & D1 < D10 & D10 < D100   ~ 'Activation',
                                  is.na(D1) == T & D10 > D100 & D100 > D1000   ~ 'Inhibitor',
                                  is.na(D1) == T & D10 < D100 & D100 < D1000   ~ 'Activation',
                                  TRUE ~ 'FALSE'))
```

Now, we can look at the drugs that are actually inhibiting a lot of reagents or not...

```{r}
InhibitionRatio <- Doseresponse %>% group_by(drug, dose_response) %>%
  # calculate the number of reagent and stimulation where it has the dose_response behavior
  dplyr::summarise(N = n()) %>% 
  arrange(desc(N)) %>%
  dcast(drug ~ dose_response, value.var = "N") %>%
  mutate(total = `FALSE`+ `Activation` + `Inhibitor`) %>%
  # calculate the % of the time the drug behave as an inhibitor
  mutate(inhib_prop = `Inhibitor` / total*100)%>% 
  # calculate the % of the time the drug behave as an activator
  mutate(activ_prop = `Activation` / total*100)%>% 
  arrange(desc(inhib_prop + activ_prop))

head(InhibitionRatio)
```

We can now look more precisely to each row (1 drug, 1stim, 1reagent, 4doses) if the inhibitor or activation behavior seems to be linear. The rsq ($R^2$) score is a good way to know if the linear fit is a good one and consequently if the effect of the drug is "real" (proportional to the concentration).

**+++ Maybe we can use other models than only linear model to be sure we tried several options to capture the trend of a drug on a specific reagent**

**+++ We have 4 patients now so we should build thos regressions using all the available data and even this step could come before the inhibitorscore calculated previously (looking at the slope of the approximation would help us determine if a drug behave like an activator/inhibitor or FALSE).**

```{r}
Potency = Doseresponse %>% 
  dplyr::filter(dose_response != "FALSE") %>%
  dplyr::select(-D0) %>% # removing D0 (DMSO = no drug)
  mutate(feature=row_number()) %>% 
  pivot_longer(starts_with("D1")) %>% 
  group_by(feature) %>% 
  mutate(x=name) %>% 
  nest() %>% 
  mutate(# linear model fitting
         model = map(data, ~ lm(value ~ x, data = .)), 
         # summary of the linear model
         result = map(model, function(x) list(intercept= x$coef[1], 
                                              slope = x$coef[2],
                                              rsq = summary(x)$r.squared))) %>% 
  unnest_wider(result) %>%
  unnest(data)
```

### Visualization

-   Slopes from the 15 Drugs assay project

```{r}
drug <- "Clotrimazole"
```

```{r}
## Creating a dataframe of the slopes (DrugPopulation ~ stimulation + reagent)
mat <- Potency %>%
  # choosing one arbitrary dose (all the doses are part of the same model)
  dplyr::filter(name == "D10") %>% 
  dplyr::filter(drug == drug) %>%
  dplyr::select(drug, population, reagent, stimulation, slope) %>%
  dcast(drug + population ~ reagent + stimulation, value.var = "slope") %>%
  # concatenate the metadata
  tidyr::unite(rowname, drug, population) %>%
  tibble::column_to_rownames() %>%
  t()

# Replacing missing values with 0
mat[is.na(mat)] <- 0 

## Plot

#Set color palette
colors <- c(min(mat),seq(-0.45,0.4,by=0.05),max(mat))
my_palette <- c("red",colorRampPalette(colors = c("red", "white", "blue"))
                                                   (n = length(colors)-3), "blue")

# Annotation
Annotation <- as.data.frame(rownames(mat))
colnames(Annotation) <- "Name"
Annotation <- Annotation %>% 
   separate(Name, c("element", "protein", "stim"), sep = "_")

annot_row <- data.frame(Stim = Annotation$stim,
                       Protein = Annotation$protein)
rownames(annot_row) <- rownames(mat)
annot_colors <- list(Stim = c(brewer.pal(5, "Set1")),
                    Protein = c(brewer.pal(11, "Set3")))
names(annot_colors$Stim) <- unique(annot_row$Stim)
names(annot_colors$Protein) <- unique(annot_row$Protein)

# Pheatmap
pheatmap(
  mat               = t(mat),
  #color             = myColor,
  #color             = viridis(length(mat_breaks) - 1),
  color             = my_palette,
  #color = colorRampPalette(c("red", "white", "blue"))(50),
  breaks            = colors,
  border_color      = NA,
  annotation_col    = annot_row,
  annotation_colors = annot_colors,
  #annotation_colors = RowSideColors,
  drop_levels       = TRUE,
  fontsize          = 10,
  main              = "Clotrimazole Potency",
  cellwidth         = 10, 
  cellheight        = 10)
```

### Comparison with the Onset of Labor features (drug score)

Here we want to visualize if the effect of a drug on the features selected in preterm birth (PTB) study are opposite to the behavior these features have in preterm pregnant women. This will help us score the different drugs and find the ones that should be able to postpone the onset of labor and so prevent pregnant women from going into labor too early.

-   Making sure we have comparable features on the drugs and on the OOL Study

```{r}
OOLfeatures <- colnames(read.csv("/Users/jonasamar/Stabl/Drug Study/Onset of Labor csv/immunome_EGA_OOL.csv"))[-c(1,2)]

drug <- "Clotrimazole" #all the drugs have the same features
drug_pred_features <- Potency %>%
                        dplyr::filter(name == "D10") %>% # D1, D10, D100, D1000 are part of the same model
                        dplyr::filter(drug == drug) %>%
                        dplyr::select(population, reagent, drug, stimulation, slope) %>%
                        dcast(drug  ~ population + reagent + stimulation, value.var = "slope") %>% 
                        select(-c("drug")) %>%
                        colnames() %>%
                        str_replace_all(c("GM-CSF" = "GMCSF",
                                          "Unstim" = "unstim",
                                          "164Dy" = "156Gd",
                                          "168Yb" = "168Er"))

intersection <- intersect(drug_pred_features, OOLfeatures)

print("")
print(paste0("Number of features in OOL Study : ",length(OOLfeatures)))
print(paste0("Number of features in the Drug Study : ",length(drug_pred_features)))
print(paste0("Number of commmon features : ",length(intersection)))
```

Given that all the features in the OOL Study are not used in the Drug Study, it is very important to only consider the features that are actually in the Drug Study when building the model to predict the time to labor.

We create a file with the list of those features:

```{r}
write.csv(intersection, paste(out_path, "features.csv", sep = "/"))
```

-   First score : $\Sigma_{features}|MaxProp*slope|$

```{r}
#List of features from own TTL model:
featuretable <- read.csv("/Users/jeinhaus/Downloads/Results Reanalysis_OOL_for_PTB_assay_without_EGA[22]/Multivariate Results/immunome_noEGA_pen_OOL/STABL_selection_Reanalysis_OOL_for_PTB_assay_without_EGA_immunome_noEGA_pen_OOL/Max STABL scores.csv")
colnames(featuretable)[1] <- "feature"
featuretable0_2 <- featuretable[1:18,]
```

```{r}
# Drug slopes on the PTB features 
Drugs = unique(Potency$drug)
test <- NULL

for (drug in Drugs){
  # population + reagent + stimulation ~ slopes
  drug_pred_feature <- Potency %>%
    dplyr::filter(name == "D10") %>% # D1, D10, D100, D1000 are part of the same model
    dplyr::filter(drug == drug) %>%
    dplyr::select(population, reagent, drug, stimulation, slope) %>%
    dcast(drug  ~ population + reagent + stimulation, value.var = "slope") %>% 
    t() %>% 
    as.data.frame() %>%
    row_to_names(row_number = 1) %>% 
    rownames_to_column(var = "feature")
  
  # keeping only the slopes of relevant features
  test<- left_join(featuretable0_2, drug_pred_feature, by = "feature")
  featuretable <- cbind(featuretable, test[3])
  }

featuretable[is.na(featuretable)] <- 0
```

```{r}
write.csv(featuretable, "overview_drugs_features.csv")
```

```{r}
# Drug scores on the PTB features
summary.score = data.frame(matrix(ncol = 2, nrow = 0))
colnames(summary.score) = c("drug", "score")

for(drug in Drugs){
  cal = featuretable %>% dplyr::select(c(drug))
  
  # feature importance * drug effect on the feature
  score <- as.numeric(featuretable$Max.Proba)*as.numeric(unlist(cal)) 
  score_f <- sum(abs(score)*100)
  
  new.row <- data.frame(drug = drug, score = score_f)
  summary.score <- rbind(summary.score, new.row)
  }
```

```{r}
summary.score %>% arrange(desc(score))
summary.score
```

-   Second score : $\Sigma_{features}|FeatureCoeff*slope|$

```{r}
# List of features from own TTL model:
ina.features <- data.frame(feature = c("CD56loCD16posNK_153Eu_STAT1_IFNa",
                                       "CD4Tnaive_159Tb_MAPKAPK2_IFNa",
                                       "ncMCs_149Sm_CREB_GM-CSF",
                                       "CD8Tem_159Tb_MAPKAPK2_IFNa",
                                       "pDCs_153Eu_STAT1_IFNa",
                                       "Bcells_159Tb_MAPKAPK2_LPS",
                                       "CD4Tem_159Tb_MAPKAPK2_Unstim",
                                       "CD8Tem_159Tb_MAPKAPK2_Unstim",
                                       "pDCs_168Yb_STAT6_IFNa",
                                       "pDCs_159Tb_MAPKAPK2_IFNa"),
                           coefficient = c("1",  "1","1","1","1","1","1","1","1","1"))

featuretable <- data.frame(feature = c("CD56loCD16posNK_153Eu_STAT1_IFNa",
                                       "CD4Tnaive_159Tb_MAPKAPK2_IFNa",
                                       "ncMCs_149Sm_CREB_GM-CSF",
                                       "CD8Tem_159Tb_MAPKAPK2_IFNa",
                                       "pDCs_153Eu_STAT1_IFNa",
                                       "Bcells_159Tb_MAPKAPK2_LPS",
                                       "CD4Tem_159Tb_MAPKAPK2_Unstim",
                                       "CD8Tem_159Tb_MAPKAPK2_Unstim",
                                       "pDCs_168Yb_STAT6_IFNa",
                                       "pDCs_159Tb_MAPKAPK2_IFNa"),
                           coefficient = c("-161.23", "-8.92", "8.11","1.28","-5.05","-2.96","1.69","-5.9","0.8","0.36"))
```

```{r}
# Drug slopes on the PTB features 
Drugs = unique(Potency$drug)
test <- NULL

for (drug in Drugs){
  # population + reagent + stimulation ~ slopes
  drug_pred_feature <- Potency %>%
    dplyr::filter(name == "D10") %>% # D1, D10, D100, D1000 are part of the same model
    dplyr::filter(drug == drug) %>%
    dplyr::select(population, reagent, drug, stimulation, slope) %>%
    dcast(drug  ~ population + reagent + stimulation, value.var = "slope") %>% 
    t() %>% 
    as.data.frame() %>%
    row_to_names(row_number = 1) %>% 
    rownames_to_column(var = "feature")
  
  # keeping only the slopes of relevant features
  test<- left_join(ina.features, drug_pred_feature, by = "feature")
  featuretable <- cbind(featuretable, test[3])
}

featuretable[is.na(featuretable)] <- 0
```

```{r}
write.csv(featuretable, "overview_drugs_features.csv")
```

```{r}
# Drug scores on the PTB features
summary.score = data.frame(matrix(ncol = 2, nrow = 0))
colnames(summary.score) = c("drug", "score")

for(drug in Drugs){
  cal = featuretable %>% dplyr::select(c(drug))
  
  # feature importance * drug effect on the feature
  score <- as.numeric(featuretable$coefficient)*as.numeric(unlist(cal)) 
  score_f <- sum(abs(score)*100)
  
  new.row <- data.frame(drug = drug, score = score_f)
  summary.score <- rbind(summary.score, new.row)
  }
```

```{r}
summary.score %>% arrange(desc(score))
summary.score
```

```{r}

#scoretable.ina = as.data.frame(drug_pred_feature[, (names(drug_pred_feature) %in% ina.features$feature)]) #scoretable.model = as.data.frame(drug_pred_feature[, (colnames(drug_pred_feature) %in% predictive.features$feature)])

#score.ina = rowSums(abs(scoretable.ina))*100 score.model= rowSums(abs(scoretable.model))*100

#new.row <- data.frame(drug = i, score.ina = score.ina, score.model = score.model) 
#summary.score <- rbind(summary.score, new.row)}

#scoretable.test = data.frame(matrix(ncol = 11, nrow = 0)) colnames(scoretable.test) = c("drug", #"CD56loCD16negNK_153Eu_STAT1_IFNa", "CD4Tnaive_159Tb_MAPKAPK2_IFNa", "ncMCs_149Sm_CREB_GM-CSF", #"CD8Tem_159Tb_MAPKAPK2_IFNa", "pDCs_153Eu_STAT1_IFNa", "Bcells_159Tb_MAPKAPK2_LPS", #"CD4Tem_159Tb_MAPKAPK2_Unstim", "CD8Tem_159Tb_MAPKAPK2_Unstim", "pDCs_168Yb_STAT6_IFNa", #"pDCs_159Tb_MAPKAPK2_IFNa")

#scoretable.test1 = merge(scoretable.test, drug_pred_feature, all.x = T)

```
