---
title: "Onset of Labor analysis drug assay"
output: html_document
date: '2023-01-31'
---
```{r setup, include=FALSE}
#setwd("/Users/jeinhaus/Library/Mobile Documents/com~apple~CloudDocs/Documents/Stanford PostDoc/05 Drug Assay Preterm #Birth/R analysis")
#funct_path = "/Users/jeinhaus/Library/Mobile Documents/com~apple~CloudDocs/Documents/Stanford PostDoc/05 Drug Assay #Preterm Birth/R analysis/Onset of Labor Study Reanalysis PTB drug assay matching gates.csv"
#out_path = "/Users/jeinhaus/Library/Mobile Documents/com~apple~CloudDocs/Documents/Stanford PostDoc/05 Drug Assay #Preterm Birth/R analysis"

setwd("/Users/jonasamar/Stabl/Drug Study/Rscripts")
funct_path = "/Users/jonasamar/Stabl/Drug Study/Onset of Labor csv/Onset of Labor Study Reanalysis PTB drug assay matching gates.csv"
out_path = "/Users/jonasamar/Stabl/Drug Study/Onset of Labor csv"
```

## Libraries

```{r}
library(tidyselect)
library(reshape2)
library(dplyr)
library(pheatmap)
library(RColorBrewer)
library(viridis)
library(paletteer)
library(readxl)
library(tidyr)
```

## Restructuring the Data

```{r}
MyData = read.csv(funct_path)
head(MyData)
```

```{r}
MyData= MyData %>% 
  rename("stimulation" = "Stims") %>%
  dplyr::mutate(ID = paste0("P",ID, "_", GA)) %>% # Creating a new index ID
  filter(ID != "Pinternalcontrol_na") %>%
  select(-c(EGA, GA, DOS))

MyData$ID = as.character(MyData$ID)
```

## Preprocessing of the features

Here use the asinh transform on the cytometry data and build a feature that is actually the difference between stimulated and un-stimulated samples 

```{r}
final_data = c()
fil = c("population","reagent","ID")

for(timepoint in unique(MyData$ID)){
  
  MyData_timepoint = MyData %>% 
    filter(ID == timepoint)
  
  head(MyData_timepoint)
  
  stims = unique(MyData_timepoint$stimulation) 
  
  MyData_timepoint = MyData_timepoint %>% 
    mutate(feature = asinh(median/5))
    
  MyData_timepoint = MyData_timepoint %>%
    select(-c("median")) %>%
    pivot_wider(names_from = stimulation, values_from = feature)
  
  for (stim in stims){
    if (stim!="unstim"){
      MyData_timepoint[stim] = MyData_timepoint[stim] - MyData_timepoint["unstim"]
    }
  }
  
  MyData_fin = MyData_timepoint %>%
    pivot_longer(-all_of(fil), names_to="stimulation",values_to="feature")
  
  final_data = rbind(final_data, MyData_fin)
}
```

```{r}
write.csv(final_data, paste(out_path, "preprocessed_OOL.csv", sep = "/"), row.names=FALSE)
```

## Creating data files

### Unpenalized data

```{r}
x = final_data[!grepl("pp", final_data$ID),] %>% #removing pp ID which correspond to post partum data
  dcast(ID ~ population + reagent + stimulation, value.var = "feature")

TTL = read.csv(funct_path)
TTL = TTL %>% 
  rename("stimulation" = "Stims") %>% 
  dplyr::mutate(ID = paste0("P",ID, "_", GA)) %>% # Creating a new index ID
  filter(ID != "Pinternalcontrol_na") %>%
  select(c(EGA, DOS, ID)) %>%
  filter(!grepl("pp", ID)) %>% 
  group_by(ID) %>% 
  filter(row_number()==1) %>%
  mutate(DOS = as.numeric(DOS)) %>%
  mutate(EGA = as.numeric(EGA))
```

```{r}
# Dataset with NO Estimator of EGA
im_noEGA = x 

# Dataset with Estimator of EGA
im_EGA = merge(x, select(TTL, "EGA"), by = "ID")
```

Creating the csv files.

```{r}
write.csv(im_noEGA, paste(out_path, "immunome_noEGA_OOL.csv", sep = "/"), row.names=FALSE)
write.csv(im_EGA, paste(out_path, "immunome_EGA_OOL.csv", sep = "/"), row.names=FALSE)
```

Creating the csv file for the outcomes

```{r}
DOS = subset(TTL, select = c(ID, DOS))
EGA = subset(TTL, select = c(EGA, ID))

# Building a first estimate of time to labor based on EGA : 7*(EGA - 40)
EGA_error = merge(DOS, EGA, by="ID") %>%
            mutate(error = DOS - 7*(EGA-40)) %>%
            select(c("ID", "error"))

write.csv(DOS, paste(out_path, "outcome_OOL.csv", sep = "/"), row.names=FALSE)
write.csv(EGA_error, paste(out_path, "EGA_error.csv", sep = "/"), row.names=FALSE)
```

### Penalized Data

```{r}
penalization_preprocessing <- function(penlization_matrix, name){
  penlization_matrix <- penlization_matrix %>%
  `colnames<-`(c("population", colnames(penlization_matrix)[-1])) %>%
  mutate(population = as.factor(population)) %>%
  gather("protein", "penalization", -population) %>% 
  mutate(feature = paste0(population, "_",protein, paste("_",name, sep=""))) %>% 
  filter(penalization == 0)
}
```

Getting the features to remove due to penalization

```{r}
#path_to_file = "/Users/jeinhaus/Library/Mobile Documents/com~apple~CloudDocs/Documents/Stanford PostDoc/05 Drug   #Assay Preterm #Birth/R analysis/penalization matrix drug assay.xlsx"

path_to_file = "/Users/jonasamar/Stabl/Drug Study/Drug assay csv/penalization matrix drug assay.xlsx"
stims = c("IFNa","LPS","IL246","GMCSF")
discard = c()

for (stim in stims){
  new_penalization = penalization_preprocessing(read_xlsx(path_to_file, sheet = stim)[1:12], stim)
  discard <- c(discard, new_penalization$feature)
}
```

Creating the data files with penalization

```{r}
im_noEGA_pen  <- select(im_noEGA, -one_of(discard))
im_EGA_pen  <- select(im_EGA, -one_of(discard))
```

```{r}
write.csv(im_noEGA_pen, paste(out_path, "immunome_noEGA_pen_OOL.csv", sep = "/"), row.names=FALSE)
write.csv(im_EGA_pen, paste(out_path, "immunome_EGA_pen_OOL.csv", sep = "/"), row.names=FALSE)
```

## Features selected by STABL : analysis

```{r}
#featuretable <- read.csv("/Users/jeinhaus/Downloads/Results Reanalysis_OOL_for_PTB_assay_without_EGA[22]/Multivariate #Results/immunome_noEGA_pen_OOL/STABL_selection_Reanalysis_OOL_for_PTB_assay_without_EGA_immunome_noEGA_pen_OOL/Max STABL #scores.csv")

featuretable <- read.csv("/Users/jonasamar/Stabl/Drug Study/Results Reanalysis_OOL_for_PTB_assay_without_EGA/Multivariate Results/immunome_noEGA_pen_OOL/STABL_selection_Reanalysis_OOL_for_PTB_assay_without_EGA_immunome_noEGA_pen_OOL/Max STABL scores.csv")

modelfeatures <- featuretable %>%
                    `colnames<-`(c("feature", colnames(featuretable)[-1])) %>%
                    slice(1:18) %>%
                    select(c("feature")) %>%
                    unlist()

model0_2 <- im_noEGA %>% 
              select(modelfeatures) %>% 
              mutate(DOS = TTL$DOS)

colnames(model0_2)[1:length(modelfeatures)] <- modelfeatures

#lm0_2 = lm(DOS~model0_2[1:18], data = model0_2) #Create the linear regression
lm0_2 <- lm(DOS~ ., data = model0_2)

summary(lm0_2) #Review the results
```



