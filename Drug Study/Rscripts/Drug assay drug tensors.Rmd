---
title: "Drug effect tensors"
output: html_notebook
---

Here we are building tensors for each drug to simulate the effect of a drug at IC50 on a given sample.
The asumptions are:
1 - the effect at IC50 is reached between the concentration 0 (DMSO) and the maximum concentration that is tested in the study
2 - the linear models that were built to model the effect of a drug on a given feature is well enough representation of the effect of the drug
3 - the effect of the drug doesn't depend on the time it is applied to the pregnant woman

## Paths

```{r}
setwd("/Users/jonasamar/Stabl/Drug Study/Rscripts")
OOL_path="/Users/jonasamar/Stabl/Drug Study/Onset of Labor csv"
drug_assay_path="/Users/jonasamar/Stabl/Drug Study/Drug assay csv"
```

## Libraries

```{r}
library(dplyr)
library(tidyr)
library(tibble)
library(ggplot2)
library(gridExtra)
```

## Drug effect tensors

For a given drug, the drug effect tensor is a dataframe with two columns :
1 - the name of the features
2 - the effect of the drug on the feature which going to be calculated as follow
$$effect_{i,j} \: = \: \alpha(scale_{DrugAssay->OOL}(f_{i,j}(C_{max,j})) - scale_{DrugAssay->OOL}(f_{i,j}(0)))$$
where $\alpha=1/2$, $f_{i,j}$ is the the linear model built on the medians of feature i when exposed to drug j, $(C_{max,j})$ is the maximum drug concentration tested for drug j, $scale_{DrugAssay->OOL}()$ transform values from the scale of the Drug assay study to the scale of the OOL study.

Importing linear models and data

```{r}
# MedianDoseresponse
load(paste0(drug_assay_path, "/median pen dose response with scales.rda"))
# AllPenDoseresponse
load(paste0(drug_assay_path, "/all pen dose response with scales.rda"))
# pseudo_log10.median.linear.model
load(paste0(drug_assay_path,"/pseudo_log10 median linear models.rda"))
# Removing the datapoints that are post partum
OOL_data <- read.csv(paste0(OOL_path, "/immunome_noEGA_DOS_pen_OOL.csv"), row.names = 1) %>% 
              filter(DOS <= 0)
```

Tensors

(First attempt of drug tensor : with the a vlue to translate the whole dataset... not showing something great : all the drugs seem to accelerate pregnancy)

```{r}
# Initializing an neutral dataframe with Drugs as columns and features as rows
type <- "proportional" # or "constant"
Drugs <- unique(MedianDoseresponse$drug)
features <- unique(MedianDoseresponse$feature)
drug.effect.tensor <- data.frame(matrix(0, nrow = length(features), ncol = length(Drugs))) %>%
                        `rownames<-`(features) %>%
                        `colnames<-`(Drugs)

# Gathering the maximum concentrations for each drug,feature combination
C_max <- MedianDoseresponse %>%
          group_by(feature, drug) %>%
          summarize(Cmax = max(pseudo_log_dose)) %>%
          select(feature, drug, Cmax)

# Progress bar
pb <- txtProgressBar(min = 0, max = length(Drugs)*length(features), style = 3)
i <- 0

# Filling the drug.effect.tensor with their actual values
for (drug.name in colnames(drug.effect.tensor)){
  for (feature.name in rownames(drug.effect.tensor)){
    # Progress bar
    setTxtProgressBar(pb, i)
    # Getting the model
    model <- pseudo_log10.median.linear.model[(pseudo_log10.median.linear.model$drug==drug.name) &
                                            (pseudo_log10.median.linear.model$feature==feature.name),]$model[[1]]
    # Getting the maximum concentration
    cmax <- C_max[(C_max$drug==drug.name) & (C_max$feature==feature.name),]$Cmax
    # Predicting y0 and ymax
    ## When we don't have a model 
    if (class(model) == "list"){
      y <- NA
    ## When we actually have a model
    }else{
      y <- predict(model, data.frame(dose=c(0, cmax)))
      # Scale transform
      if (type=="constant"){
        drug_assay_values <- c(y, AllPenDoseresponse[AllPenDoseresponse$feature==feature.name,]$value)
        OOL_values <- OOL_data[,feature.name]
        z_scores <- scale(drug_assay_values)
        OOL_mean <- mean(OOL_values)
        OOL_sd <- sd(OOL_values)
        scaled_drug_assay_values <- OOL_sd*z_scores + OOL_mean
        y <- c(scaled_drug_assay_values[[1]], scaled_drug_assay_values[[2]])
      }
    }
    # Adding the effect to the tensor
    drug.effect.tensor[feature.name, drug.name] <- ifelse(any(is.na(y)), 0, 
                                                          ifelse(type=="constant",(y[[2]] - y[[1]])/2, (y[[2]] - y[[1]])/(2*max(abs(y)))))
    # Incrementation for progress bar
    i <- i + 1
  }
}
```

## Effect on the OOL data

Importing the data

```{r}
# Timepoints
DOS <- OOL_data$DOS

# Keeping a copy of OOL_data
original.OOL_data <- OOL_data

# Removing DOS from OOL_data since already stored
OOL_data <- select(OOL_data, -DOS)
```

Function building and applying drug effect matrix on the OOL_data

```{r}
apply.effect.matrix <- function(target_drug, type="proportional"){
  # Creating a dataframe similar in shape to OOL_data with the drug effect as values instead of the actual values of the feature
  effect.matrix <- data.frame(matrix(drug.effect.tensor[,target_drug], 
                                     ncol = length(rownames(OOL_data)), 
                                     nrow = nrow(drug.effect.tensor),
                                     dimnames = list(rownames(drug.effect.tensor), rownames(OOL_data)))) %>%
                    rbind(data.frame(matrix(0,
                                            nrow = ncol(OOL_data) - nrow(drug.effect.tensor),
                                            ncol = length(rownames(OOL_data)),
                                            dimnames = list(setdiff(colnames(OOL_data), rownames(drug.effect.tensor)), 
                                                            rownames(OOL_data))))) %>%
                    t() %>%
                    as.data.frame() %>%
                    select(all_of(colnames(OOL_data)))
  
  if (type=="proportional"){
    # Depending on wheter the OOL data is positive or negative we add or subtract the absolute change
    effect.matrix <- 1 + sign(OOL_data)*effect.matrix
    # Applying the effect.matrix to the OOL_data
    return(effect.matrix*OOL_data)
  }
  if (type=="constant"){
    # Applying the effect.matrix to the OOL_data
    return(effect.matrix + OOL_data)
  }
  print("Type not recognized")
}
```

Saving the data with the simulated effect

```{r}
all.simulated.data <- data.frame(ID = character(),
                                 drug = character(),
                                 feature = character(),
                                 value = double(),
                                 stringsAsFactors = FALSE)
for (target_drug in colnames(drug.effect.tensor)){
  simulated.OOL <- apply.effect.matrix(target_drug, type) %>%
                  rownames_to_column(var = "ID") %>%
                  pivot_longer(cols = -ID, names_to = "feature", values_to = "value") %>%
                  mutate(drug = target_drug)
  all.simulated.data <- rbind(all.simulated.data, simulated.OOL)
}
all.simulated.data <- pivot_wider(all.simulated.data, names_from="feature", values_from="value")
# Saving the stimulated data
save(all.simulated.data, file=paste0(OOL_path, "/immunome_noEGA_OOL_with_drugs.rda"))
```

## Visualization

Feature of importance : we import the feature index and look at the features with model_index > 0.

```{r}
# feature.index
load(paste0(OOL_path, "/feature_index.rda"))

# List of the features of interest
feature_list <- feature.index[(feature.index$model_index > 0) & (!is.na(feature.index$model_index)), "feature"]
```

Loading OOL models for the plot

```{r}
# Loading the models for the plot
df_sum <- read.csv(paste0(OOL_path, "/pen_classification_curves_cytof.csv"))
# df_models
load(paste0(OOL_path, "/pen_model_curves_cytof.rda"))
```

Function creating and saving the plots to visualize the simulated drug effect

```{r}
plot.drug.effect <- function(target_drug, OOL_data.with.drug.effect){
  plots <- list()
  for (target_feature in feature_list) {
    coefs <- df_models[df_models$feature == target_feature,]$model[[1]][[1]]
    
    # building the predictions
    y <- OOL_data[, target_feature]
    intercept <- coefs[['(Intercept)']]
    if (length(coefs) == 3){ # quadratic model
      a <- coefs[['DOS2']]
      b <- coefs[['DOS']]
      y_pred <- intercept + b * DOS + a * DOS^2
    }
    else{ # length(coefs) == 2, linear model
      slope <- coefs[['DOS']]
      y_pred <- intercept + slope * DOS
    }
    
    df <- data.frame(x = DOS, y = y, y_pred = y_pred)
    pval <- df_sum[df_sum$cytof == target_feature,]$pval
    
    # Adding the points with the drug effect
    df2 <- data.frame(x = DOS, y = OOL_data.with.drug.effect[, target_feature])
    
    # Plot
    plot <- ggplot(df, aes(x = x, y = y, color="without")) +
        geom_point(size = 1, na.rm = TRUE) +
        geom_point(data = df2, aes(x = x, y = y, color="with"), size = 1, na.rm = TRUE) +
        geom_line(aes(y = y_pred), color = "red") +
        ggtitle(paste(target_feature, pval, sep=",\np = ")) +
        xlab(NULL) +  # Remove x-axis label
        ylab(NULL) +  # Remove y-axis label
        theme(plot.title = element_text(size = 12), 
              legend.position = "bottom", 
              legend.text = element_text(size = 8),
              legend.title = element_text(size = 8),
              legend.margin = margin(-10, 0, 0, 0)) +
        scale_color_manual(name=paste(target_drug, 'treatment'), breaks=c("without", "with"),
                           values=c("without"='blue', "with"='green'))
  
    plots[[target_feature]] <- plot
  }
  
  # Saving the plots
  pdf(paste(OOL_path, "/plots/best_features_with_", target_drug, "_effect.pdf", sep=""))
  for (i in 0:(ceiling(length(plots)/4)-1)){
    grid.arrange(grobs = plots[(4*i + 1):min(length(plots),(4*i + 4))], nrow = 2, ncol = 2)
  }
  dev.off()
}

```

Plotting

```{r}
for (target_drug in colnames(drug.effect.tensor)){
  plot.drug.effect(target_drug, apply.effect.matrix(target_drug))
}
```



